<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ë≤™È£üËõáÔºöZ‰∏ñ‰ª£Ë¶∫ÈÜí (2026 Edition)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Bungee&family=Noto+Sans+TC:wght@400;700&display=swap');
        
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #0f172a;
            color: #f8fafc;
            overflow: hidden;
            touch-action: none;
        }

        .game-font { font-family: 'Bungee', cursive; }

        canvas {
            image-rendering: pixelated;
            border-radius: 12px;
            box-shadow: 0 0 30px rgba(139, 92, 246, 0.4);
            max-width: 100%;
            height: auto;
        }

        .neon-border {
            border: 2px solid #8b5cf6;
            box-shadow: 0 0 15px #8b5cf6, inset 0 0 5px #8b5cf6;
        }

        .btn-pulse:hover {
            transform: scale(1.05);
            transition: transform 0.2s;
            filter: brightness(1.2);
        }

        #ui-overlay {
            background: rgba(15, 23, 42, 0.85);
            backdrop-filter: blur(8px);
        }

        .skill-card:hover {
            border-color: #f59e0b;
            background: rgba(245, 158, 11, 0.1);
        }

        .leaderboard-list::-webkit-scrollbar {
            width: 4px;
        }
        .leaderboard-list::-webkit-scrollbar-thumb {
            background: #475569;
            border-radius: 10px;
        }

        input::placeholder {
            color: #64748b;
        }
    </style>
</head>
<body class="flex flex-col items-center justify-center min-h-screen p-4">

    <!-- È†ÇÈÉ®Ë≥áË®äÊ¨Ñ -->
    <div class="w-full max-w-2xl mb-4 flex justify-between items-end">
        <div>
            <h1 class="text-3xl font-bold game-font text-violet-400">SNAKE <span class="text-white">GEN-Z</span></h1>
            <p class="text-xs text-slate-400">LEVEL <span id="lvl-display">1</span>: <span id="lvl-name">Ëø∑Âõ†Ê£ÆÊûó</span></p>
        </div>
        <div class="text-right">
            <div class="text-2xl game-font" id="score-display">0000</div>
            <div class="text-[10px] text-violet-300 uppercase tracking-widest">High Score: <span id="high-score">0</span></div>
        </div>
    </div>

    <!-- ÈÅäÊà≤‰∏ªÈ´î -->
    <div class="relative">
        <canvas id="gameCanvas"></canvas>
        
        <!-- UI ÁñäÂä†Â±§ -->
        <div id="ui-overlay" class="absolute inset-0 flex flex-col items-center justify-center rounded-xl z-10">
            <!-- ÈñãÂßãÈÅ∏ÂñÆ -->
            <div id="menu-start" class="text-center w-full max-w-xs px-6">
                <div class="text-6xl mb-4">üêç</div>
                <h2 class="text-4xl font-bold mb-6 game-font">WHO IS PLAYING?</h2>
                
                <div class="mb-4 text-left">
                    <label class="text-[10px] uppercase tracking-widest text-violet-400 ml-1">Enter Your Tag</label>
                    <input type="text" id="player-name-input" maxlength="12" placeholder="TYPE YOUR NAME..." 
                        class="w-full bg-slate-900 border-2 border-slate-700 focus:border-violet-500 text-white rounded-xl px-4 py-3 outline-none transition-all text-center font-bold">
                </div>

                <button id="start-btn" class="w-full px-8 py-4 bg-violet-600 rounded-xl font-bold text-xl neon-border btn-pulse uppercase tracking-wider mb-4">
                    Play Now
                </button>
                <p class="text-slate-500 text-[10px] uppercase">Use WASD or Arrows to Glide</p>
                <p id="auth-status" class="mt-2 text-[10px] text-slate-600 italic">Ê≠£Âú®ÈÄ£Áµê‰º∫ÊúçÂô®...</p>
            </div>

            <!-- ÊäÄËÉΩÈÅ∏Êìá -->
            <div id="menu-upgrade" class="hidden text-center w-full px-8">
                <h2 class="text-3xl font-bold mb-6 text-amber-400 game-font">SELECT A SKILL</h2>
                <div class="grid grid-cols-1 gap-4" id="skill-list"></div>
            </div>

            <!-- ÈÅäÊà≤ÁµêÊùü -->
            <div id="menu-gameover" class="hidden text-center w-full max-w-xs px-4">
                <h2 class="text-5xl font-bold mb-2 text-red-500 game-font">WASTED</h2>
                <p class="text-xl mb-4 text-slate-300"><span id="player-display-name" class="text-violet-400"></span> ËÆäÊàê‰∫ÜËø∑Âõ†...</p>
                
                <div class="grid grid-cols-2 gap-2 mb-4">
                    <div class="px-4 py-2 bg-slate-800 rounded-lg">
                        <p class="text-[10px] text-slate-400">SCORE</p>
                        <p class="text-xl font-bold text-white" id="final-score">0</p>
                    </div>
                    <div class="px-4 py-2 bg-slate-800 rounded-lg">
                        <p class="text-[10px] text-slate-400">BEST</p>
                        <p class="text-xl font-bold text-amber-400" id="final-best">0</p>
                    </div>
                </div>

                <div class="bg-slate-900/50 rounded-lg p-3 mb-4 border border-slate-700">
                    <p class="text-xs font-bold text-violet-400 mb-2 uppercase tracking-widest">Global Leaderboard</p>
                    <div id="leaderboard-content" class="leaderboard-list max-h-32 overflow-y-auto text-left text-xs space-y-1">
                        <p class="text-center text-slate-500">ËºâÂÖ•‰∏≠...</p>
                    </div>
                </div>

                <button id="restart-btn" class="w-full px-8 py-3 bg-white text-slate-900 rounded-full font-bold text-xl btn-pulse uppercase">Try Again</button>
            </div>
        </div>
    </div>

    <!-- Â∫ïÈÉ®ÊéßÂà∂ÊèêÁ§∫ -->
    <div class="mt-6 w-full max-w-2xl flex items-center justify-between text-slate-500">
        <div class="flex gap-2">
            <span class="px-2 py-1 bg-slate-800 rounded text-xs border border-slate-700">W/A/S/D</span>
            <span class="px-2 py-1 bg-slate-800 rounded text-xs border border-slate-700">TOUCH</span>
        </div>
        <div class="text-xs flex flex-col items-end">
            <span>2026 NEXT-GEN PROTOTYPE</span>
            <span id="user-id-display" class="text-[8px] opacity-50">ID: Guest</span>
        </div>
    </div>

    <div id="toast" class="fixed bottom-10 left-1/2 -translate-x-1/2 px-6 py-3 bg-violet-600 text-white rounded-full font-bold opacity-0 transition-opacity pointer-events-none z-50">
        Level Up!
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, collection, query, getDocs, limit } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Firebase ÈÖçÁΩÆ ---
        const userProvidedConfig = {
            apiKey: "AIzaSyCXWAaG4qAirb5v6zdX4SkiQCr1Jh0Ax-0",
            authDomain: "projectai01.firebaseapp.com",
            projectId: "projectai01",
            storageBucket: "projectai01.firebasestorage.app",
            messagingSenderId: "146920420601",
            appId: "1:146920420601:web:ff3007c657c817fbf1de28"
        };

        const firebaseConfig = typeof __firebase_config !== 'undefined' 
            ? JSON.parse(__firebase_config) 
            : userProvidedConfig;

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        let user = null;
        let playerName = localStorage.getItem('snake_player_name') || "";

        // --- ÈÅäÊà≤ÁµÑ‰ª∂ÂºïÁî® ---
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const overlay = document.getElementById('ui-overlay');
        const lvlDisplay = document.getElementById('lvl-display');
        const lvlNameDisplay = document.getElementById('lvl-name');
        const scoreDisplay = document.getElementById('score-display');
        const highScoreDisplay = document.getElementById('high-score');
        const finalScoreDisplay = document.getElementById('final-score');
        const finalBestDisplay = document.getElementById('final-best');
        const toast = document.getElementById('toast');
        const authStatus = document.getElementById('auth-status');
        const userIdDisplay = document.getElementById('user-id-display');
        const leaderboardContent = document.getElementById('leaderboard-content');
        const nameInput = document.getElementById('player-name-input');
        const playerDisplayName = document.getElementById('player-display-name');

        const GRID_SIZE = 20;
        let TILE_COUNT;
        let snake = [];
        let food = { x: 5, y: 5, type: 'üëç' };
        let direction = { x: 0, y: 0 };
        let nextDirection = { x: 1, y: 0 };
        let score = 0;
        let highScore = localStorage.getItem('snake_high_score') || 0;
        let gameState = 'START';
        let level = 1;
        let gameSpeed = 120;
        let lastTime = 0;
        let bullets = [];
        let aiSnake = null;
        let skills = { magnet: 0, speed: 1, bullet: false, ghost: false };

        const MEME_FOODS = ['üçï', 'üçî', 'üåÆ', 'ü§°', 'üî•', 'üíÄ', 'üëΩ', 'üçÜ', 'üåà', 'üí∏'];
        const LEVEL_DATA = [
            { name: "Ëø∑Âõ†Ê£ÆÊûó", target: 50, speed: 120 },
            { name: "ÊäÄËÉΩË¶∫ÈÜí", target: 150, speed: 110 },
            { name: "ÂΩàÂπïÂ∞ÑÊìä", target: 300, speed: 100 },
            { name: "AI ÂΩ±‰πãËõá", target: 500, speed: 90 },
            { name: "Â∑îÂ≥∞Á´∂ÊäÄÂ†¥", target: 1000, speed: 80 }
        ];

        // --- ÂàùÂßãÂåñ Auth ---
        async function initAuth() {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Auth error:", error);
                authStatus.innerText = "ÈÄ£Á∑öÂ§±ÊïóÔºåÂÉÖÈôêÈõ¢Á∑öÊ®°Âºè";
            }
        }

        onAuthStateChanged(auth, (u) => {
            user = u;
            if (user) {
                authStatus.innerText = "Â∑≤ÈÄ£Á∑öËá≥Èõ≤Á´Ø‰º∫ÊúçÂô®";
                userIdDisplay.innerText = `ID: ${user.uid.substring(0,8)}...`;
            }
        });

        // --- ÊéíË°åÊ¶úÈÇèËºØ ---
        async function saveHighScore(pts) {
            if (!user) return;
            try {
                const leaderDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'leaderboard', user.uid);
                await setDoc(leaderDocRef, {
                    uid: user.uid,
                    displayName: playerName || "Anon",
                    score: pts,
                    timestamp: Date.now()
                }, { merge: true });
            } catch (e) {
                console.error("Error saving score:", e);
            }
        }

        async function fetchLeaderboard() {
            if (!user) return;
            try {
                leaderboardContent.innerHTML = '<p class="text-center text-slate-500 animate-pulse">Êõ¥Êñ∞ÊéíË°åÊ¶ú‰∏≠...</p>';
                const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'leaderboard'), limit(50));
                const querySnapshot = await getDocs(q);
                let scores = [];
                querySnapshot.forEach((doc) => scores.push(doc.data()));

                scores.sort((a, b) => b.score - a.score);

                leaderboardContent.innerHTML = '';
                scores.slice(0, 10).forEach((item, index) => {
                    const isMe = item.uid === user.uid;
                    const display = item.displayName || item.uid.substring(0, 8);
                    const div = document.createElement('div');
                    div.className = `flex justify-between items-center py-1 border-b border-slate-800/50 ${isMe ? 'text-amber-400 font-bold' : 'text-slate-400'}`;
                    div.innerHTML = `
                        <span>${index + 1}. ${display}</span>
                        <span class="game-font">${item.score}</span>
                    `;
                    leaderboardContent.appendChild(div);
                });
            } catch (e) {
                console.error("Error fetching leaderboard:", e);
                leaderboardContent.innerHTML = '<p class="text-center text-red-500">ÊéíË°åÊ¶úËºâÂÖ•Â§±Êïó</p>';
            }
        }

        // --- Ê†∏ÂøÉÈÅäÊà≤ÊµÅÁ®ã ---
        function init() {
            resizeCanvas();
            highScoreDisplay.innerText = highScore;
            nameInput.value = playerName; // Â°´ÂÖ•Ë®òÊÜ∂ÁöÑÂêçÁ®±

            window.addEventListener('resize', resizeCanvas);
            
            // ÈçµÁõ§ËàáËß∏ÊéßÈÇèËºØ
            window.addEventListener('keydown', e => {
                if (gameState !== 'PLAYING') return;
                switch(e.key.toLowerCase()) {
                    case 'arrowup': case 'w': if (direction.y === 0) nextDirection = { x: 0, y: -1 }; break;
                    case 'arrowdown': case 's': if (direction.y === 0) nextDirection = { x: 0, y: 1 }; break;
                    case 'arrowleft': case 'a': if (direction.x === 0) nextDirection = { x: -1, y: 0 }; break;
                    case 'arrowright': case 'd': if (direction.x === 0) nextDirection = { x: 1, y: 0 }; break;
                }
            });

            document.getElementById('start-btn').onclick = validateAndStart;
            document.getElementById('restart-btn').onclick = startGame;
            
            initAuth();
            requestAnimationFrame(gameLoop);
        }

        function validateAndStart() {
            const inputName = nameInput.value.trim();
            if (inputName === "") {
                nameInput.classList.add('border-red-500');
                setTimeout(() => nameInput.classList.remove('border-red-500'), 1000);
                return;
            }
            playerName = inputName;
            localStorage.setItem('snake_player_name', playerName);
            startGame();
        }

        function resizeCanvas() {
            const size = Math.min(window.innerWidth - 40, 500);
            canvas.width = size;
            canvas.height = size;
            TILE_COUNT = Math.floor(size / GRID_SIZE);
        }

        function startGame() {
            score = 0;
            level = 1;
            snake = [{ x: 10, y: 10 }, { x: 9, y: 10 }, { x: 8, y: 10 }];
            nextDirection = { x: 1, y: 0 };
            direction = { x: 0, y: 0 };
            bullets = [];
            aiSnake = null;
            skills = { magnet: 0, speed: 1, bullet: false, ghost: false };
            updateScore(0);
            spawnFood();
            setGameState('PLAYING');
            updateLevelDisplay();
        }

        function setGameState(state) {
            gameState = state;
            document.getElementById('menu-start').classList.toggle('hidden', state !== 'START');
            document.getElementById('menu-upgrade').classList.toggle('hidden', state !== 'UPGRADE');
            document.getElementById('menu-gameover').classList.toggle('hidden', state !== 'GAMEOVER');
            overlay.classList.toggle('hidden', state === 'PLAYING');
        }

        function spawnFood() {
            food = {
                x: Math.floor(Math.random() * TILE_COUNT),
                y: Math.floor(Math.random() * TILE_COUNT),
                type: MEME_FOODS[Math.floor(Math.random() * MEME_FOODS.length)]
            };
        }

        function updateScore(pts) {
            score += pts;
            scoreDisplay.innerText = score.toString().padStart(4, '0');
            if (score > highScore) {
                highScore = score;
                highScoreDisplay.innerText = highScore;
                localStorage.setItem('snake_high_score', highScore);
            }
            if (level < 5 && score >= LEVEL_DATA[level - 1].target) levelUp();
            if (pts > 0 && score % 50 === 0) showUpgradeMenu();
        }

        function levelUp() {
            level++;
            showToast(`LEVEL UP: ${LEVEL_DATA[level-1].name}`);
            updateLevelDisplay();
            gameSpeed = LEVEL_DATA[level-1].speed;
            if (level === 3) skills.bullet = true;
            if (level === 4) spawnAISnake();
        }

        function updateLevelDisplay() {
            lvlDisplay.innerText = level;
            lvlNameDisplay.innerText = LEVEL_DATA[level-1].name;
        }

        function showToast(msg) {
            toast.innerText = msg;
            toast.style.opacity = '1';
            setTimeout(() => toast.style.opacity = '0', 2000);
        }

        function showUpgradeMenu() {
            setGameState('UPGRADE');
            const list = document.getElementById('skill-list');
            list.innerHTML = '';
            const options = [
                { id: 'magnet', name: 'Á£ÅÂê∏Âäõ', desc: 'ÂêÉË±ÜÁØÑÂúçÊì¥Â§ß', icon: 'üß≤' },
                { id: 'speed', name: 'Ë∂ÖÈ†ªÂä†ÈÄü', desc: 'ÁßªÂãïÈÄüÂ∫¶ÊèêÂçá', icon: '‚ö°' },
                { id: 'ghost', name: 'ÂπΩÈùàÂåñ', desc: 'ÈÄèÊòéÊÑüÊèêÂçá', icon: 'üëª' }
            ];
            options.forEach(opt => {
                const btn = document.createElement('button');
                btn.className = "skill-card flex items-center p-4 bg-slate-800 rounded-xl border border-slate-700 transition-all text-left";
                btn.innerHTML = `
                    <div class="text-3xl mr-4">${opt.icon}</div>
                    <div><div class="font-bold text-white uppercase">${opt.name}</div><div class="text-[10px] text-slate-400">${opt.desc}</div></div>
                `;
                btn.onclick = () => {
                    if (opt.id === 'magnet') skills.magnet += 1;
                    if (opt.id === 'speed') skills.speed += 0.3;
                    if (opt.id === 'ghost') skills.ghost = true;
                    setGameState('PLAYING');
                };
                list.appendChild(btn);
            });
        }

        function spawnAISnake() {
            aiSnake = { body: [{ x: 0, y: 0 }, { x: 0, y: 1 }, { x: 0, y: 2 }], dir: { x: 0, y: 1 } };
        }

        function update() {
            if (gameState !== 'PLAYING') return;
            direction = nextDirection;
            const head = { x: snake[0].x + direction.x, y: snake[0].y + direction.y };

            if (head.x < 0 || head.x >= TILE_COUNT || head.y < 0 || head.y >= TILE_COUNT || 
                snake.some(seg => seg.x === head.x && seg.y === head.y)) {
                gameOver();
                return;
            }

            snake.unshift(head);
            const dist = Math.hypot(head.x - food.x, head.y - food.y);
            const reach = 0.5 + (skills.magnet * 0.5);
            
            if (dist < reach) {
                updateScore(10);
                spawnFood();
                if (skills.bullet) bullets.push({ x: head.x, y: head.y, dx: direction.x, dy: direction.y });
            } else {
                snake.pop();
            }

            bullets.forEach((b, i) => {
                b.x += b.dx * 0.5; b.y += b.dy * 0.5;
                if (b.x < 0 || b.x > TILE_COUNT || b.y < 0 || b.y > TILE_COUNT) bullets.splice(i, 1);
            });

            if (aiSnake) {
                const aiHead = aiSnake.body[0];
                if (Math.random() < 0.2) {
                    if (aiHead.x < snake[0].x) aiSnake.dir = { x: 1, y: 0 };
                    else if (aiHead.x > snake[0].x) aiSnake.dir = { x: -1, y: 0 };
                    else if (aiHead.y < snake[0].y) aiSnake.dir = { x: 0, y: 1 };
                    else aiSnake.dir = { x: 0, y: -1 };
                }
                aiSnake.body.unshift({ x: aiHead.x + aiSnake.dir.x, y: aiHead.y + aiSnake.dir.y });
                aiSnake.body.pop();
                if (aiSnake.body.some(seg => seg.x === head.x && seg.y === head.y)) gameOver();
            }
        }

        async function gameOver() {
            setGameState('GAMEOVER');
            finalScoreDisplay.innerText = score;
            finalBestDisplay.innerText = highScore;
            playerDisplayName.innerText = playerName;
            
            if (user) {
                await saveHighScore(highScore);
                fetchLeaderboard();
            }
        }

        function draw() {
            ctx.fillStyle = '#0f172a';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // ËÉåÊôØÊ†ºÁ∑ö
            ctx.strokeStyle = '#1e293b'; ctx.lineWidth = 0.5;
            for(let i=0; i<TILE_COUNT; i++) {
                ctx.beginPath(); ctx.moveTo(i*GRID_SIZE, 0); ctx.lineTo(i*GRID_SIZE, canvas.height); ctx.stroke();
                ctx.beginPath(); ctx.moveTo(0, i*GRID_SIZE); ctx.lineTo(canvas.width, i*GRID_SIZE); ctx.stroke();
            }

            // È£üÁâ©ËàáÂΩàÂπï
            ctx.font = `${GRID_SIZE * 0.8}px Arial`;
            ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
            ctx.fillText(food.type, food.x * GRID_SIZE + GRID_SIZE/2, food.y * GRID_SIZE + GRID_SIZE/2);

            ctx.fillStyle = '#f59e0b';
            bullets.forEach(b => {
                ctx.beginPath(); ctx.arc(b.x * GRID_SIZE + GRID_SIZE/2, b.y * GRID_SIZE + GRID_SIZE/2, 4, 0, Math.PI*2); ctx.fill();
            });

            // AI Ëõá
            if (aiSnake) {
                ctx.fillStyle = '#ef4444';
                aiSnake.body.forEach((seg, i) => {
                    ctx.globalAlpha = 1 - (i / aiSnake.body.length);
                    ctx.fillRect(seg.x * GRID_SIZE + 2, seg.y * GRID_SIZE + 2, GRID_SIZE - 4, GRID_SIZE - 4);
                });
                ctx.globalAlpha = 1;
            }

            // Áé©ÂÆ∂Ëõá
            snake.forEach((seg, i) => {
                const isHead = i === 0;
                ctx.fillStyle = isHead ? '#a78bfa' : '#7c3aed';
                if (skills.ghost) ctx.globalAlpha = 0.6;
                ctx.beginPath();
                ctx.roundRect(seg.x * GRID_SIZE + 1, seg.y * GRID_SIZE + 1, GRID_SIZE - 2, GRID_SIZE - 2, isHead?6:4);
                ctx.fill();
                if (isHead) {
                    ctx.fillStyle = 'white';
                    ctx.beginPath(); ctx.arc(seg.x * GRID_SIZE + 6, seg.y * GRID_SIZE + 6, 2, 0, Math.PI*2); ctx.fill();
                    ctx.beginPath(); ctx.arc(seg.x * GRID_SIZE + 14, seg.y * GRID_SIZE + 6, 2, 0, Math.PI*2); ctx.fill();
                }
            });
            ctx.globalAlpha = 1;
        }

        function gameLoop(timestamp) {
            const elapsed = timestamp - lastTime;
            if (elapsed > gameSpeed / (skills.speed || 1)) {
                update(); draw(); lastTime = timestamp;
            }
            requestAnimationFrame(gameLoop);
        }

        window.onload = init;
    </script>
</body>
</html>
